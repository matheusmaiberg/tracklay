# ============================================================
# TRACKLAY - ENVIRONMENT VARIABLES
# VERSION 3.0.0 - BREAKING CHANGES
# ============================================================
# ‚ö†Ô∏è IMPORTANT: Version 3.0.0 removes ALL legacy detectable routes
#
# BREAKING CHANGE: The following routes are NO LONGER SUPPORTED:
#   ‚ùå /cdn/fbevents.js, /cdn/gtm.js, /cdn/gtag.js
#   ‚ùå /tr, /g/collect, /j/collect
#   ‚ùå /assets/*, /static/* variants (all removed)
#
# ‚úÖ ONLY obfuscated UUID-based routes remain:
#   - /cdn/f/{UUID}-script.js
#   - /cdn/g/{UUID}-gtm.js
#   - /cdn/g/{UUID}-tag.js
#   - /cdn/f/{UUID}.js, /cdn/g/{UUID}.js (endpoints)
#
# üìö MIGRATION REQUIRED: See docs/MIGRATION-V3.md
#
# If upgrading from v2.x:
#   1. Update your Shopify theme with obfuscated URLs (npm run urls)
#   2. Test on preview theme
#   3. THEN deploy v3.0.0 Worker
#
# ============================================================
# Copy this file to .env and fill in your values
# For production, set these in Cloudflare Dashboard:
# Workers > Your Worker > Settings > Variables

# ============================================================
# REQUIRED: OBFUSCATION (Anti-Ad-Blocker)
# VERSION 3.0.0: UUID-based routes are NOW MANDATORY
# ============================================================
# UUID-based endpoint obfuscation - CRITICAL for bypassing ad-blockers
# Generate UUIDs: node -e "console.log(require('crypto').randomUUID())"
#
# ‚ö†Ô∏è v3.0.0 CHANGE: Legacy routes have been REMOVED
# These UUIDs are now the ONLY way to access tracking functionality
#
# Security Impact:
# - v2.x: Optional UUIDs, legacy routes still worked (90-100% detection)
# - v3.0.0: Mandatory UUIDs, no fallback routes (10-20% detection)
#
# Get your obfuscated URLs: npm run urls

# Facebook Pixel endpoint UUID (REQUIRED for obfuscation)
# Creates obfuscated paths:
#   - /cdn/f/{UUID}-script.js ‚Üí Facebook script
#   - /cdn/f/{UUID}.js ‚Üí Facebook tracking endpoint
FACEBOOK_ENDPOINT_ID=a8f3c2e1-4b9d-4f5a-8c3e-2d1f9b4a7c6e

# Google Analytics/GTM endpoint UUID (REQUIRED for obfuscation)
# Creates obfuscated paths:
#   - /cdn/g/{UUID}-gtm.js ‚Üí GTM script
#   - /cdn/g/{UUID}-tag.js ‚Üí GTag script
#   - /cdn/g/{UUID}.js ‚Üí GA4 tracking endpoint
GOOGLE_ENDPOINT_ID=b7e4d3f2-5c0e-4a6b-9d4f-3e2a0c5b8d7f

# UUID Secret for hash generation (RECOMMENDED)
# Generate: node -e "console.log(require('crypto').randomUUID())"
# Or set via: wrangler secret put UUID_SECRET
#
# v3.0.0 TIP: Rotate your UUIDs every 1-3 months for maximum security
# When rotating: Update both FACEBOOK_ENDPOINT_ID, GOOGLE_ENDPOINT_ID
# and your Shopify theme simultaneously (see docs/MIGRATION-V3.md)
UUID_SECRET=your-secret-uuid-here

# ============================================================
# REQUIRED: CORS ORIGINS
# ============================================================
# Your Shopify store domains (comma-separated)
# Include BOTH myshopify.com and custom domain
ALLOWED_ORIGINS=https://yourstore.myshopify.com,https://www.yourstore.com

# ============================================================
# OPTIONAL: GTM SERVER-SIDE / PROXY CONFIGURATION
# ============================================================
# Configure where GA4 tracking requests should be proxied to
#
# ‚ö†Ô∏è THREE OPTIONS:
#
# 1Ô∏è‚É£ CLIENT-SIDE ONLY (No proxy for GA4 tracking)
#    Leave empty. GA4 goes directly to www.google-analytics.com
#    GTM_SERVER_URL=
#
# 2Ô∏è‚É£ PROXY VIA CLOUDFLARE WORKER (Recommended for ad-blocker bypass)
#    Set to your worker domain. Worker proxies /g/collect to Google
#    This enables first-party GA4 tracking through your domain
GTM_SERVER_URL=https://cdn.yourstore.com
#
#    Result:
#      GA4 ‚Üí cdn.yourstore.com/g/collect ‚Üí Worker ‚Üí www.google-analytics.com/g/collect
#
# 3Ô∏è‚É£ REAL GTM SERVER-SIDE CONTAINER (Advanced - requires Google Cloud)
#    Set to your GTM Server container URL (Google Cloud Run)
#    GTM_SERVER_URL=https://your-container-id.run.app
#
#    Result:
#      GA4 ‚Üí cdn.yourstore.com/g/collect ‚Üí Worker ‚Üí your-container.run.app/g/collect
#
# When set, creates these proxy endpoints:
#   /g/collect ‚Üí {GTM_SERVER_URL}/g/collect (GA4 tracking)
#   /j/collect ‚Üí {GTM_SERVER_URL}/j/collect (JavaScript errors)
#   /cdn/g/{UUID}.js ‚Üí {GTM_SERVER_URL}/g/collect (obfuscated endpoint)

# ============================================================
# OPTIONAL: DEBUG CONFIGURATION
# ============================================================
# Enable debug headers for development/staging
# When enabled, adds headers like X-Script-Key, X-Script-Hash, X-Cache-Status
# and exposes detailed metrics in /health endpoint
#
# ‚ö†Ô∏è IMPORTANT: Set to false in production to maintain obfuscation
#
# Debug headers expose internal state and can be used for ad-blocker
# fingerprinting. Only enable for local development or staging environments.
#
# Headers added when DEBUG_HEADERS=true:
# - X-Script-Key: Which script is served (fbevents/gtm/gtag)
# - X-Script-Hash: SHA-256 hash of script content
# - X-Cache-Updated/Refreshed: Cache update timestamps
# - X-Cache-Type: Cache state (stale/fresh)
# - X-Cache-Status: Cache hit/miss status
# - Health endpoint: UUID, metrics, Cloudflare info
#
# Security impact:
# - Production (false): Detection rate <10%, maximum obfuscation
# - Development (true): Detection rate 50%+, fingerprinting possible
#
# See: docs/OBFUSCATION.md (lines 114-132, 540-546)
#
# Default: false (production-safe)
# DEBUG_HEADERS=false

# For development/staging (optional):
# DEBUG_HEADERS=true

# ============================================================
# ULTRA-AGGRESSIVE: CONTAINER ALIASES (OPTIONAL)
# ============================================================
# Obfuscate GTM/GA4 container IDs in query strings
# Maps short random aliases to real container IDs
#
# WITHOUT obfuscation (detectable):
#   /cdn/g/{UUID}?id=GTM-XXXXX
#   ‚ùå "GTM-" pattern is detectable by ad-blockers
#
# WITH obfuscation (ultra-aggressive):
#   /cdn/g/{UUID}?c=abc123
#   ‚úÖ Fully obfuscated, no detectable patterns
#
# Format: JSON object mapping aliases to real IDs
# Example:
# CONTAINER_ALIASES='{"abc123":"GTM-XXXXX","def456":"G-YYYYY"}'
#
# How to generate random aliases:
# node -e "console.log(require('crypto').randomBytes(4).toString('hex'))"
# ‚Üí Output: a1b2c3d4 (use this as your alias)
#
# Security benefits:
# - Hides GTM-/G- patterns from ad-blocker pattern matching
# - Query strings appear random and meaningless
# - Can rotate aliases independently of UUIDs
#
# Default: empty object (passthrough mode, no query obfuscation)
# CONTAINER_ALIASES={}

# Example configuration (uncomment and customize):
# CONTAINER_ALIASES='{"a1b2c3":"GTM-XXXXX","d4e5f6":"G-YYYYY"}'

# ============================================================
# UUID ROTATION CONFIGURATION
# ============================================================
# Control whether endpoint UUIDs rotate automatically based on time
#
# HOW IT WORKS:
# - Rotation uses deterministic time-based UUID generation
# - UUIDs change weekly based on UUID_SALT_ROTATION interval (default: 7 days)
# - All workers generate the same UUID at the same time (stateless)
# - No KV/Durable Objects needed (everything is time-based)
#
# ROTATION ENABLED (false - RECOMMENDED):
#   ENDPOINTS_UUID_ROTATION=false
#   - UUIDs change every UUID_SALT_ROTATION interval (7 days)
#   - Maximum security (UUIDs expire automatically)
#   - Shopify theme must fetch UUIDs dynamically via /endpoints
#   - Week-based rotation: Math.floor(Date.now() / UUID_SALT_ROTATION)
#
# ROTATION DISABLED (true - simpler setup):
#   ENDPOINTS_UUID_ROTATION=true
#   - UUIDs stay fixed (from FACEBOOK_ENDPOINT_ID, GOOGLE_ENDPOINT_ID)
#   - Can hardcode in Shopify theme
#   - Lower security (UUIDs valid forever if discovered)
#
# Default: false (rotation enabled for maximum security)
# ENDPOINTS_UUID_ROTATION=false

# ============================================================
# AUTHENTICATED ENDPOINT SECRET
# ============================================================
# Secret token for /endpoints authentication (query string based)
# Shopify theme/n8n uses this to fetch current rotating UUIDs
#
# ‚ö†Ô∏è CRITICAL SECURITY:
# - NEVER expose UUIDs publicly (e.g., in /health endpoint)
# - NEVER commit this secret to git
# - Ad-blockers can scrape public endpoints and blacklist UUIDs
#
# AUTHENTICATION METHOD:
# - Query string based: GET /endpoints?token=your-secret
# - NOT using Authorization header (easier for n8n/GitHub Actions)
#
# Set via Cloudflare Workers secret (RECOMMENDED for production):
#   wrangler secret put ENDPOINTS_SECRET
#
# Generate secure token:
#   node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
#
# Example output: a3f9c2e1b8d4f5a6c7e8d9f0a1b2c3d4e5f6a7b8c9d0e1f2a3b4c5d6e7f8a9b0
#
# For local development only (use wrangler secret in production):
ENDPOINTS_SECRET=your-generated-secret-token-here

# ============================================================
# OPTIONAL: ADVANCED SETTINGS
# ============================================================
# Only customize these if you need non-default behavior

# Rate Limiting (default: 100 requests per minute)
# RATE_LIMIT_REQUESTS=100
# RATE_LIMIT_WINDOW=60000

# Fetch timeout in milliseconds (default: 10s)
# FETCH_TIMEOUT=10000

# Cache TTL in seconds for proxied scripts (default: 1 hour)
# CACHE_TTL=3600

# Maximum request body size in bytes (default: 1MB)
# MAX_REQUEST_SIZE=1048576

# UUID salt rotation interval in milliseconds (default: 7 days)
# UUID_SALT_ROTATION=604800000

# Log level: debug, info, warn, error (default: info)
# LOG_LEVEL=info

# ============================================================
# FOR CLOUDFLARE DEPLOYMENT (wrangler CLI)
# ============================================================
# These are used by wrangler for deployment
# Not passed to the worker itself

# Your Cloudflare Account ID (get from: wrangler whoami)
# CLOUDFLARE_ACCOUNT_ID=your-account-id

# Your Cloudflare API Token (create at: Cloudflare Dashboard > My Profile > API Tokens)
# CLOUDFLARE_API_TOKEN=your-api-token
