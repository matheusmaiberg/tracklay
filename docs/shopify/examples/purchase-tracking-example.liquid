{% comment %}
  ============================================================
  EXAMPLE: Purchase Tracking with Shopify Data
  ============================================================
  Add this to your theme.liquid or checkout completion page
  This example shows how to send Shopify order data to Worker

  LOCATION:
  - theme.liquid (for order status page)
  - OR Additional Scripts section (Settings → Checkout → Order status page)

  SHOPIFY DATA AVAILABLE:
  - customer.* (if logged in)
  - checkout.* (checkout data)
  - order.* (completed order)
  - shop.* (store info)
{% endcomment %}

{% if checkout.order %}
<script>
(function() {
  'use strict';

  // Configuration
  const WORKER_URL = 'https://cdn.suevich.com/cdn/events';
  const MEASUREMENT_ID = 'G-N5ZZGL11MW';

  /**
   * Get client ID from cookie
   */
  function getClientId() {
    const match = document.cookie.match('(^|;)\\s*_ga\\s*=\\s*([^;]+)');
    return match ? match.pop() : `GA1.1.${Math.random().toString(36).substring(2)}.${Date.now()}`;
  }

  /**
   * Track purchase event with full Shopify data
   */
  function trackPurchase() {
    const payload = {
      // GA4 required fields
      event_name: 'purchase',
      client_id: getClientId(),
      measurement_id: MEASUREMENT_ID,
      session_id: Date.now().toString(),
      engagement_time_msec: '100',

      // Page info
      page_location: window.location.href,
      page_title: document.title,
      page_referrer: document.referrer || '',

      // Timestamp
      timestamp_micros: (Date.now() * 1000).toString(),

      // ============= SHOPIFY ORDER DATA =============
      // Transaction info
      transaction_id: '{{ checkout.order.id }}',
      order_number: '{{ checkout.order.name }}',
      affiliation: '{{ shop.name }}',

      // Financial data
      value: {{ checkout.total_price | money_without_currency | remove: ',' }},
      currency: '{{ checkout.currency }}',
      tax: {{ checkout.tax_price | money_without_currency | remove: ',' }},
      shipping: {{ checkout.shipping_price | money_without_currency | remove: ',' }},

      {% if checkout.discount_applications.size > 0 %}
      // Discount info
      coupon: '{{ checkout.discount_applications[0].title }}',
      discount: {{ checkout.discount_applications[0].total_allocated_amount | money_without_currency | remove: ',' }},
      {% endif %}

      // Customer info (if available)
      {% if customer %}
      customer_id: '{{ customer.id }}',
      customer_email: '{{ customer.email }}',
      customer_first_name: '{{ customer.first_name }}',
      customer_accepts_marketing: {{ customer.accepts_marketing }},
      customer_order_count: {{ customer.orders_count }},
      customer_total_spent: {{ customer.total_spent | money_without_currency | remove: ',' }},
      {% endif %}

      // Shipping info
      shipping_tier: '{{ checkout.shipping_method.title }}',
      shipping_country: '{{ checkout.shipping_address.country_code }}',
      shipping_city: '{{ checkout.shipping_address.city }}',

      // Payment info
      payment_type: '{{ checkout.transactions[0].gateway }}',

      // Store info
      shop_domain: '{{ shop.domain }}',
      shop_currency: '{{ shop.currency }}',

      // ============= ITEMS (Products) =============
      items: [
        {% for line_item in checkout.line_items %}
        {
          item_id: '{{ line_item.product_id }}',
          item_name: '{{ line_item.title | escape }}',
          item_variant: '{{ line_item.variant_title | escape }}',
          item_brand: '{{ line_item.vendor | escape }}',
          price: {{ line_item.price | money_without_currency | remove: ',' }},
          quantity: {{ line_item.quantity }},
          item_sku: '{{ line_item.sku }}',
          item_variant_id: '{{ line_item.variant_id }}'
        }{% unless forloop.last %},{% endunless %}
        {% endfor %}
      ]
    };

    // Send to Worker
    fetch(WORKER_URL, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(payload),
      keepalive: true
    })
    .then(response => {
      if (response.ok) {
        console.log('[Purchase Tracking] Event sent successfully');
      } else {
        console.error('[Purchase Tracking] Failed:', response.statusText);
      }
    })
    .catch(error => {
      console.error('[Purchase Tracking] Error:', error);
    });
  }

  // Track purchase when page loads
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', trackPurchase);
  } else {
    trackPurchase();
  }

})();
</script>
{% endif %}
