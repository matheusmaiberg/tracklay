# ============================================================
# CLOUDFLARE WRANGLER CONFIGURATION - EXAMPLE FILE
# ============================================================
# Copy this file to wrangler.toml and customize for your setup
#
# IMPORTANT:
# - This file configures the Worker runtime behavior
# - Secrets (OBFUSCATION_SECRET, ENDPOINTS_API_TOKEN) must be set via:
#     wrangler secret put OBFUSCATION_SECRET
#     wrangler secret put ENDPOINTS_API_TOKEN
# - For local development, create .dev.vars file with secrets
# - NEVER commit wrangler.toml with real account_id or secrets!
# ============================================================

# ============================================================
# WORKER IDENTIFICATION
# ============================================================
name = "tracklay"
main = "worker.js"
compatibility_date = "2026-01-26"

# Modern Node.js compatibility
compatibility_flags = ["nodejs_compat"]

# ============================================================
# CLOUDFLARE ACCOUNT (REQUIRED FOR DEPLOY)
# ============================================================
# Get your account ID: wrangler whoami
# Uncomment and fill before deploying:
# account_id = "your-account-id-here"

# ============================================================
# ROUTES (Custom Domain) - OPTIONAL
# ============================================================
# Configure routes to serve the worker from your own domain
# Requires your domain to be on Cloudflare
#
# [[routes]]
# pattern = "cdn.yourstore.com/*"
# zone_name = "yourstore.com"
#
# [[routes]]
# pattern = "www.yourstore.com/cdn/*"
# zone_name = "yourstore.com"

# ============================================================
# ENVIRONMENT VARIABLES ([vars])
# ============================================================
# These are NON-SECRET configurations visible in the Worker
# For SECRETS, use: wrangler secret put <NAME>
# ============================================================

[vars]

# ============= REQUIRED CONFIGURATION =============
# These should be configured for your specific setup

# Your worker domain (required for Full Script Proxy cron jobs)
# Must be the full URL without trailing slash
# Example: "https://cdn.yourstore.com"
WORKER_BASE_URL = "https://cdn.yourstore.com"

# CORS Origins - domains allowed to use your proxy
# Comma-separated list, no spaces
# Example: "https://yourstore.com,https://www.yourstore.com"
ALLOWED_ORIGINS = "https://yourstore.com,https://www.yourstore.com"

# Facebook Pixel obfuscation UUID
# Generate: node -e "console.log(require('crypto').randomUUID())"
# This creates the endpoint: /cdn/f/{UUID}
OBFUSCATION_FB_UUID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# Google Analytics/GTM obfuscation UUID
# Generate: node -e "console.log(require('crypto').randomUUID())"
# This creates the endpoint: /cdn/g/{UUID}
OBFUSCATION_GA_UUID = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# ============= OPTIONAL CONFIGURATION =============
# These have sensible defaults - only change if needed

# GTM Server-Side URL (optional)
# Only needed if using GTM Server-Side container
# Leave as empty string "" if not using
GTM_SERVER_URL = ""

# Debug headers (development: true, production: false)
DEBUG_HEADERS_ENABLED = "false"

# Full Script Proxy - rewrites URLs inside tracking scripts
# Set to "true" for maximum ad-blocker bypass
FULL_SCRIPT_PROXY_ENABLED = "true"

# UUID Rotation - auto-rotate endpoints weekly
# "true" = rotation enabled, "false" = fixed UUIDs (recommended)
UUID_ROTATION_ENABLED = "false"

# UUID rotation interval in milliseconds (default: 7 days = 604800000)
UUID_ROTATION_INTERVAL_MS = "604800000"

# GTM Container aliases (JSON string for query obfuscation)
# Example: {"abc123":"GTM-XXXXXX","def456":"G-XXXXXXXX"}
GTM_CONTAINER_ALIASES = "{}"

# ============= PERFORMANCE CONFIGURATION =============

# Rate limiting: max requests per window
RATE_LIMIT_REQUESTS = "100"

# Rate limiting: window duration in milliseconds (60 seconds)
RATE_LIMIT_WINDOW = "60000"

# Upstream fetch timeout in milliseconds (10 seconds)
FETCH_TIMEOUT = "10000"

# Script cache TTL in seconds (1 hour = 3600)
CACHE_TTL = "3600"

# Max request body size in bytes (1MB = 1048576)
MAX_REQUEST_SIZE = "1048576"

# Script size limit for ReDoS protection (10MB = 10485760)
SCRIPT_SIZE_LIMIT = "10485760"

# Log level: "debug", "info", "warn", or "error"
LOG_LEVEL = "info"

# ============================================================
# CRON TRIGGERS (Scheduled Events)
# ============================================================
# Automatic script cache updates
# Full Script Proxy updates cached scripts every 12 hours

[triggers]
crons = ["0 */12 * * *"]

# ============================================================
# SMART PLACEMENT
# ============================================================
# Automatically run Worker closest to backend services
# Improves latency for Full Script Proxy operations

[placement]
mode = "smart"

# ============================================================
# BUILD CONFIGURATION
# ============================================================

[build]
command = ""

# ============================================================
# ENVIRONMENTS (Optional)
# ============================================================
# Uncomment to use: wrangler deploy --env development

# [env.development]
# name = "tracklay-dev"
# vars = { ENVIRONMENT = "development", DEBUG_HEADERS_ENABLED = "true", LOG_LEVEL = "debug" }

# [env.staging]
# name = "tracklay-staging"
# vars = { ENVIRONMENT = "staging", DEBUG_HEADERS_ENABLED = "true" }

# ============================================================
# OBSERVABILITY (Optional - Cloudflare Dashboard Logs)
# ============================================================

[observability]
[observability.logs]
enabled = true
head_sampling_rate = 0.2
invocation_logs = true

[observability.traces]
enabled = true
head_sampling_rate = 0.05

# ============================================================
# DEPLOYMENT CHECKLIST
# ============================================================
# Before deploying, ensure:
#
# 1. ✓ account_id is set (uncomment line 24)
# 2. ✓ WORKER_BASE_URL is your actual domain
# 3. ✓ ALLOWED_ORIGINS includes your Shopify store domain
# 4. ✓ OBFUSCATION_FB_UUID is generated (node -e "console.log(crypto.randomUUID())")
# 5. ✓ OBFUSCATION_GA_UUID is generated (node -e "console.log(crypto.randomUUID())")
# 6. ✓ Secrets are set: wrangler secret put OBFUSCATION_SECRET
# 7. ✓ Secrets are set: wrangler secret put ENDPOINTS_API_TOKEN
# 8. ✓ Custom domain routes configured (optional but recommended)
#
# Deploy: wrangler deploy
# ============================================================
